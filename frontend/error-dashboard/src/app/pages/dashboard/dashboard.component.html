<div class="dash">

  <!-- FILTERS -->
  <app-filters-bar
    class="card"
    [form]="form"
    (preset)="setPreset($event)"
    (reset)="reset()">
  </app-filters-bar>

  <!-- ERRORS -->
  <section class="card errors-card">
    <header class="errors-header">
      <h3 class="title">Errors</h3>

      <div class="meta">
        <span class="meta-item">
          Total <strong>{{ total() | number:'1.0-0' }}</strong>
        </span>
        <span class="badge"
              *ngIf="cacheFlag() as cf"
              [class.badge-hit]="cf === 'hit'"
              [class.badge-miss]="cf === 'miss'">
          CACHE: {{ cf | uppercase }}
        </span>
      </div>

      <div class="controls">
        <div class="seg seg-pill">
          <button type="button"
                  class="seg__btn"
                  [class.active]="viewMode()==='paged'"
                  (click)="toggleViewMode('paged')">
            Paged (&lt; 10k)
          </button>
          <button type="button"
                  class="seg__btn"
                  [class.active]="viewMode()==='infinite'"
                  (click)="toggleViewMode('infinite')">
            Load more (&gt; 10k)
          </button>
        </div>
      </div>
    </header>

    <!-- Jedna tabela za oba moda (puni se tableItems()) -->
    <div class="body">
      <app-errors-table
        [items]="tableItems()"
        [loading]="viewMode()==='paged' ? state.loadingPaged() : state.loadingPt()"
        [emptyMessage]="'No data'">
      </app-errors-table>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <!-- Paged footer -->
      <app-paged-footer
        *ngIf="viewMode()==='paged'"
        [page]="currentPage()"
        [size]="pageSize()"
        [maxPage]="maxPage()"
        [windowCapped]="windowCapped()"
        (prev)="prevPage()"
        (next)="nextPage()"
        (sizeChange)="form.patchValue({ size: $event, page: 1 })"
        (goto)="form.patchValue({ page: $event })">
      </app-paged-footer>

      <!-- Infinite footer -->
      <app-infinite-footer
        *ngIf="viewMode()==='infinite'"
        [size]="pageSize()"
        [hasItems]="!!tableItems().length"
        [loading]="state.loadingPt()"
        [done]="state.ptDone()"
        (loadMore)="loadMorePt()"
        (sizeChange)="form.patchValue({ size: $event })">
      </app-infinite-footer>
    </footer>
  </section>

  <!-- RESULTS & STATS -->
  <section class="card stats-card">
    <header class="stats-header">
      <h3>Results &amp; Stats</h3>

      <div class="controls">
        <div class="seg">
          <button class="seg__btn" [class.active]="statsSource()==='es'"
                  (click)="statsSource.set('es')">ES</button>
          <button class="seg__btn" [class.active]="statsSource()==='redis'"
                  (click)="statsSource.set('redis')">Redis (Live)</button>
        </div>

        <div class="seg" *ngIf="statsSource()==='redis'">
          <button class="seg__btn" [class.active]="redisScope()==='1h'"
                  (click)="redisScope.set('1h')">Last 1h</button>
          <button class="seg__btn" [class.active]="redisScope()==='global'"
                  (click)="redisScope.set('global')">Global</button>
        </div>
      </div>
    </header>

    <div class="charts" *ngIf="showStatsSection() as s; else noStatsTpl">
      <div class="chart">
        <h4>Top Browsers</h4>
        <div class="chart-box">
          <ng-container *ngIf="hasBrowserData(); else noBrowserTpl">
            <canvas baseChart [type]="'pie'" [data]="browsersChartData()" [options]="pieOptions"></canvas>
          </ng-container>
          <ng-template #noBrowserTpl>
            <div class="no-data">No data</div>
          </ng-template>
        </div>
      </div>

      <div class="chart">
        <h4>Top Error Messages</h4>
        <div class="chart-box">
          <ng-container *ngIf="hasErrorData(); else noErrorsTpl">
            <canvas baseChart [type]="'bar'" [data]="errorMessagesChartData()" [options]="barOptions"></canvas>
          </ng-container>
          <ng-template #noErrorsTpl>
            <div class="no-data">No data</div>
          </ng-template>
        </div>
      </div>
    </div>

    <ng-template #noStatsTpl>
      <div class="no-stats">No stats</div>
    </ng-template>
  </section>

</div>
